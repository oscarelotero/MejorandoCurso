/*!Thu May 09 2013 21:39:15 */
window.Puls3={},Puls3.Views={},Puls3.Collections={},Puls3.Models={},Puls3.Routers={},window.app={},window.routers={},window.plugs={},window.views={},window.collections={},Puls3.Models.ArticleModel=Backbone.Model.extend({urlRoot:"/articles",defaults:{},prettyDate:function(e){if(!e||"0000-00-00 00:00:00"===e)return"";var e=Date.parse(e);return e.toString("MMMM dd, yyyy")},parse:function(e){return e.data?e.data:e}}),Puls3.Models.Article=Puls3.Models.ArticleModel,Puls3.Collections.ArticlesCollection=Backbone.Collection.extend({model:Puls3.Models.ArticleModel,url:"",name:"articles",search:function(e){if(""==e)return this;var t=RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))},comparator:function(e){return e.get("name")},getOne:function(e){return this.filter(function(t){return t.get("id")==e})},parse:function(e){return e.data}}),Puls3.Collections.articles=Puls3.Collections.ArticlesCollection,Puls3.Routers.BaseRouter=Backbone.Router.extend({routes:{"":"root","article/:id":"articleSingle"},initialize:function(){},root:function(){console.log("root"),window.app.state="root"},articleSingle:function(e){console.log("articleSingle",e),window.app.state="articleSingle",window.app.article=e}}),Puls3.Views.ArticleView=Backbone.View.extend({events:{"click > article":"navigate","click .likes_up":"upvote","click .likes_down":"downvote"},className:"",initialize:function(e){var t=this;this.model=e,this.model.on("change",function(){t.render()}),window.routers.on("route:root",function(){t.render()}),window.routers.on("route:articleSingle",function(){t.render()}),this.template=swig.compile($("#Article_tpl").html()),this.templateExtended=swig.compile($("#ArticleExtended_tpl").html())},navigate:function(){console.log("navigate",this.model.toJSON()),Backbone.history.navigate("article/"+this.model.get("id"),{trigger:!0})},upvote:function(e){e.stopPropagation();var t=this.model.get("votes");this.model.set("votes",parseInt(t,10)+1),this.model.save()},downvote:function(e){e.stopPropagation();var t=this.model.get("votes");this.model.set("votes",parseInt(t,10)-1),this.model.save()},render:function(){var e={post:this.model.toJSON()};return"articleSingle"===window.app.state?window.app.article===this.model.get("id")?(this.$el.show(),this.$el.html(this.templateExtended(e))):(this.$el.hide(),this.$el.html("")):this.$el.html(this.template(e)),this}}),Puls3.Views.ArticleNewView=Backbone.View.extend({events:{"click button":"create"},className:"",initialize:function(e){this.$el=e},create:function(){console.log("Button fue clickeado");var e=this.$el.find("#title").val(),t=this.$el.find("#tag").val(),o=this.$el.find("#content").val();console.log(e,t,o);var i=new Puls3.Models.Article({title:e,tag:t,content:o}),n=i.save();n.done(function(e){Backbone.history.navigate("article/"+e.id,{trigger:!0})})},render:function(){}}),$(document).ready(function(){console.log("Starting app"),window.ponyExpress=new PonyExpress({io:window.location.origin}),window.collections.articles=new Puls3.Collections.ArticlesCollection,window.ponyExpress.bind("connect",function(){window.plugs.article=new PonyExpress.BackbonePlug({collection:window.collections.articles})}),window.views.articleNew=new Puls3.Views.ArticleNewView($("#contenido > aside")),window.collections.articles.on("add",function(e){var t=new Puls3.Views.ArticleView(e);t.render(),t.$el.appendTo("#contenido")}),window.routers=new Puls3.Routers.BaseRouter;var e=$.get("/articles/all");e.done(function(e){console.log(e),e.forEach(function(e){window.collections.articles.add(e)}),Backbone.history.start({root:"/",pushState:!0,silent:!1})}),$("nav li:first").on("click",function(){Backbone.history.navigate("",{trigger:!0})})});